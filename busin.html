<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Registration - MyPlatform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .form-container {
            padding: 40px;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 3px;
            background: #e5e7eb;
            z-index: 1;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-number {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            border: 3px solid white;
            transition: all 0.3s ease;
        }

        .step-label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .progress-step.active .step-number {
            background: #4f46e5;
            color: white;
            transform: scale(1.1);
        }

        .progress-step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .progress-step.completed .step-number::after {
            content: 'âœ“';
        }

        .form-step {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-step.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 0.95rem;
        }

        .required::after {
            content: ' *';
            color: #ef4444;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5;
            background: white;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-hint {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .form-error {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .cities-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .city-tag {
            background: #e0e7ff;
            color: #3730a3;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .city-tag button {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .city-input-container {
            display: flex;
            gap: 10px;
        }

        .city-input-container input {
            flex: 1;
        }

        .btn-add-city {
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0 20px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .btn-add-city:hover {
            background: #4338ca;
        }

        .file-upload {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        .file-upload:hover {
            border-color: #4f46e5;
            background: #f0f9ff;
        }

        .file-upload i {
            font-size: 2.5rem;
            color: #6b7280;
            margin-bottom: 15px;
        }

        .file-upload input {
            display: none;
        }

        .file-name {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #6b7280;
            word-break: break-all;
        }

        .form-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #f3f4f6;
        }

        .btn {
            padding: 14px 30px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-prev {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-prev:hover {
            background: #e5e7eb;
        }

        .btn-next, .btn-submit {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            color: white;
        }

        .btn-next:hover, .btn-submit:hover {
            background: linear-gradient(to right, #4338ca, #6d28d9);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .btn-submit {
            background: linear-gradient(to right, #10b981, #059669);
        }

        .btn-submit:hover {
            background: linear-gradient(to right, #059669, #047857);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .loader {
            display: none;
            width: 25px;
            height: 25px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .message i {
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .form-container {
                padding: 25px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-building"></i> Business Registration</h1>
            <p>Complete your business profile to get started with our platform</p>
        </div>

        <div class="form-container">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Basic Info</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Contact & Links</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Documents</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Bank Details</div>
                </div>
            </div>

            <!-- Messages -->
            <div id="message" class="message"></div>

            <!-- Step 1: Basic Information -->
            <div class="form-step active" data-step="1">
                <h2 style="margin-bottom: 25px; color: #374151;">Basic Business Information</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="required" for="businessName">Business Name</label>
                        <input type="text" id="businessName" placeholder="Enter your business name">
                        <div class="form-error" id="businessNameError"></div>
                    </div>
                    <div class="form-group">
                        <label class="required" for="registrationNumber">Registration Number</label>
                        <input type="text" id="registrationNumber" placeholder="Enter registration number">
                        <div class="form-error" id="registrationNumberError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required" for="businessType">Business Type</label>
                        <select id="businessType">
                            <option value="">Select business type</option>
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <div class="form-error" id="businessTypeError"></div>
                    </div>
                    <div class="form-group">
                        <label for="vatGstNumber">VAT/GST Number</label>
                        <input type="text" id="vatGstNumber" placeholder="Enter VAT/GST number">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required" for="yearsInBusiness">Years in Business</label>
                        <input type="number" id="yearsInBusiness" min="0" max="100" placeholder="Enter years">
                        <div class="form-error" id="yearsInBusinessError"></div>
                    </div>
                    <div class="form-group">
                        <label for="serviceRadius">Service Radius (km)</label>
                        <input type="number" id="serviceRadius" min="1" max="100" value="10">
                        <div class="form-hint">Default is 10km</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required" for="businessAddress">Business Address</label>
                    <textarea id="businessAddress" placeholder="Enter full business address"></textarea>
                    <div class="form-error" id="businessAddressError"></div>
                </div>

                <div class="form-group">
                    <label class="required">Cities Served</label>
                    <div class="city-input-container">
                        <input type="text" id="cityInput" placeholder="Enter city name">
                        <button type="button" class="btn-add-city" id="addCityBtn">Add</button>
                    </div>
                    <div class="form-hint">Add all cities where you provide services</div>
                    <div class="cities-container" id="citiesContainer"></div>
                    <div class="form-error" id="citiesError"></div>
                </div>

                <div class="form-group">
                    <label class="required" for="aboutServices">About Your Services</label>
                    <textarea id="aboutServices" placeholder="Describe your services in detail"></textarea>
                    <div class="form-error" id="aboutServicesError"></div>
                </div>
            </div>

            <!-- Step 2: Contact & Social Links -->
            <div class="form-step" data-step="2">
                <h2 style="margin-bottom: 25px; color: #374151;">Contact Information & Social Links</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="required" for="contactName">Contact Person Name</label>
                        <input type="text" id="contactName" placeholder="Enter contact person name">
                        <div class="form-error" id="contactNameError"></div>
                    </div>
                    <div class="form-group">
                        <label class="required" for="phoneNumber">Phone Number</label>
                        <input type="tel" id="phoneNumber" placeholder="Enter phone number">
                        <div class="form-error" id="phoneNumberError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required" for="emailAddress">Email Address</label>
                        <input type="email" id="emailAddress" placeholder="Enter email address">
                        <div class="form-error" id="emailAddressError"></div>
                    </div>
                    <div class="form-group">
                        <label for="alternateContact">Alternate Contact</label>
                        <input type="tel" id="alternateContact" placeholder="Enter alternate contact">
                    </div>
                </div>

                <div class="form-group">
                    <label class="required" for="preferredCommunication">Preferred Communication</label>
                    <select id="preferredCommunication">
                        <option value="">Select preferred method</option>
                        <option value="Email">Email</option>
                        <option value="Phone">Phone</option>
                        <option value="WhatsApp">WhatsApp</option>
                    </select>
                    <div class="form-error" id="preferredCommunicationError"></div>
                </div>

                <div class="form-group">
                    <label for="website">Website</label>
                    <input type="url" id="website" placeholder="https://example.com">
                </div>

                <h3 style="margin: 30px 0 20px; color: #4b5563;">Social Media Links</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="linkedinProfile">LinkedIn Profile</label>
                        <input type="url" id="linkedinProfile" placeholder="https://linkedin.com/in/username">
                    </div>
                    <div class="form-group">
                        <label for="facebookPage">Facebook Page</label>
                        <input type="url" id="facebookPage" placeholder="https://facebook.com/pagename">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="instagramHandle">Instagram Handle</label>
                        <input type="text" id="instagramHandle" placeholder="@username">
                    </div>
                    <div class="form-group">
                        <label for="otherLinks">Other Links (JSON array)</label>
                        <input type="text" id="otherLinks" placeholder='["https://link1.com", "https://link2.com"]'>
                        <div class="form-hint">Enter as JSON array format</div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Documents -->
            <div class="form-step" data-step="3">
                <h2 style="margin-bottom: 25px; color: #374151;">Business Documents</h2>
                <p style="margin-bottom: 25px; color: #6b7280;">Upload required documents for verification. All documents should be in PDF, JPG, or PNG format.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="required">Government ID</label>
                        <div class="file-upload" onclick="document.getElementById('govIdFile').click()">
                            <i class="fas fa-id-card"></i>
                            <p>Click to upload Government ID (Aadhar, PAN, etc.)</p>
                            <div class="file-name" id="govIdFileName">No file chosen</div>
                            <input type="file" id="govIdFile" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                        <div class="form-error" id="govIdError"></div>
                    </div>
                    <div class="form-group">
                        <label class="required">Business License</label>
                        <div class="file-upload" onclick="document.getElementById('licenseFile').click()">
                            <i class="fas fa-file-contract"></i>
                            <p>Click to upload Business License</p>
                            <div class="file-name" id="licenseFileName">No file chosen</div>
                            <input type="file" id="licenseFile" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                        <div class="form-error" id="licenseError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Insurance Certificate (Optional)</label>
                        <div class="file-upload" onclick="document.getElementById('insuranceFile').click()">
                            <i class="fas fa-shield-alt"></i>
                            <p>Click to upload Insurance Certificate</p>
                            <div class="file-name" id="insuranceFileName">No file chosen</div>
                            <input type="file" id="insuranceFile" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Business Certificate (Optional)</label>
                        <div class="file-upload" onclick="document.getElementById('certificateFile').click()">
                            <i class="fas fa-certificate"></i>
                            <p>Click to upload Business Certificate</p>
                            <div class="file-name" id="certificateFileName">No file chosen</div>
                            <input type="file" id="certificateFile" accept=".pdf,.jpg,.jpeg,.png">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Bank Details -->
            <div class="form-step" data-step="4">
                <h2 style="margin-bottom: 25px; color: #374151;">Bank Account Details</h2>
                <p style="margin-bottom: 25px; color: #6b7280;">Provide your bank details for payment processing. This information is securely stored.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="required" for="bankName">Bank Name</label>
                        <input type="text" id="bankName" placeholder="Enter bank name">
                        <div class="form-error" id="bankNameError"></div>
                    </div>
                    <div class="form-group">
                        <label class="required" for="accountNumber">Account Number</label>
                        <input type="text" id="accountNumber" placeholder="Enter account number">
                        <div class="form-error" id="accountNumberError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="required" for="accountType">Account Type</label>
                        <select id="accountType">
                            <option value="">Select account type</option>
                            <option value="Savings">Savings</option>
                            <option value="Current">Current</option>
                            <option value="Salary">Salary</option>
                            <option value="Fixed Deposit">Fixed Deposit</option>
                        </select>
                        <div class="form-error" id="accountTypeError"></div>
                    </div>
                    <div class="form-group">
                        <label for="ifscCode">IFSC Code</label>
                        <input type="text" id="ifscCode" placeholder="Enter IFSC code">
                        <div class="form-hint">Required for Indian banks</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="subBusinessTypes">Sub Business Types (Optional)</label>
                    <input type="text" id="subBusinessTypes" placeholder='["Type1", "Type2"]'>
                    <div class="form-hint">Enter as JSON array format</div>
                </div>

                <div class="form-group">
                    <label for="serviceArea">Service Area Description</label>
                    <textarea id="serviceArea" placeholder="Describe your service area in detail"></textarea>
                </div>
            </div>

            <!-- Form Navigation -->
            <div class="form-footer">
                <button type="button" class="btn btn-prev" id="prevBtn" disabled>
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" class="btn btn-next" id="nextBtn">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button type="button" class="btn btn-submit" id="submitBtn">
                    <div class="loader"></div>
                    <span>Submit Registration</span>
                </button>
            </div>
        </div>
    </div>

    <script>
    // Supabase Configuration
    const supabaseUrl = 'https://xfeubykrdtzjhblvzote.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhmZXVieWtyZHR6amhibHZ6b3RlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMTUzNDQsImV4cCI6MjA2ODY5MTM0NH0.z8L32ROB_TgcQMRvxDVUd1WOMe6hzF3F71tgZJKaovQ';
    
    // Initialize Supabase client
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    // Application state
    const state = {
        currentStep: 1,
        totalSteps: 4,
        cities: [],
        uploadedFiles: {
            govId: null,
            license: null,
            insurance: null,
            certificate: null
        },
        businessTypes: [],
        isLoading: false,
        userId: null // This should be set based on your authentication
    };

    // DOM Elements
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const progressSteps = document.querySelectorAll('.progress-step');
    const formSteps = document.querySelectorAll('.form-step');
    const messageEl = document.getElementById('message');

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
        // Load business types from database
        loadBusinessTypes();
        
        // Set up event listeners
        setupEventListeners();
        
        // Initialize file upload handlers
        setupFileUploads();
        
        // Get current user from Supabase auth
        getCurrentUser();
    });

    // Get current authenticated user
    async function getCurrentUser() {
        try {
            const { data: { user }, error } = await supabase.auth.getUser();
            
            if (error) throw error;
            
            if (user) {
                state.userId = user.id;
                console.log('User ID:', state.userId);
            } else {
                // If no user is logged in, redirect to login page
                showMessage('error', 'Please login first to register your business.');
                setTimeout(() => {
                    window.location.href = 'provider-registration.html';
                }, 2000);
            }
        } catch (error) {
            console.error('Error getting user:', error);
            showMessage('error', 'Please login first.');
            setTimeout(() => {
                window.location.href = 'provider-registration.html';
            }, 2000);
        }
    }

    // Load business types from database
    async function loadBusinessTypes() {
        try {
            const { data, error } = await supabase
                .from('business_types')
                .select('id, name')
                .order('name');

            if (error) throw error;

            state.businessTypes = data;
            const select = document.getElementById('businessType');
            
            data.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading business types:', error);
            showMessage('error', 'Failed to load business types. Please refresh the page.');
        }
    }

    // Set up all event listeners
    function setupEventListeners() {
        // Navigation buttons
        prevBtn.addEventListener('click', goToPrevStep);
        nextBtn.addEventListener('click', goToNextStep);
        submitBtn.addEventListener('click', submitForm);
        
        // City management
        const addCityBtn = document.getElementById('addCityBtn');
        if (addCityBtn) {
            addCityBtn.addEventListener('click', addCity);
        }
        
        const cityInput = document.getElementById('cityInput');
        if (cityInput) {
            cityInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addCity();
                }
            });
        }
        
        // Form validation on input
        document.querySelectorAll('input, select, textarea').forEach(element => {
            element.addEventListener('blur', () => validateField(element));
            element.addEventListener('input', () => clearError(element.id));
        });
    }

    // Set up file upload handlers
    function setupFileUploads() {
        // Government ID
        const govIdFile = document.getElementById('govIdFile');
        if (govIdFile) {
            govIdFile.addEventListener('change', (e) => {
                handleFileUpload(e, 'govId', 'govIdFileName');
            });
        }
        
        // Business License
        const licenseFile = document.getElementById('licenseFile');
        if (licenseFile) {
            licenseFile.addEventListener('change', (e) => {
                handleFileUpload(e, 'license', 'licenseFileName');
            });
        }
        
        // Insurance Certificate
        const insuranceFile = document.getElementById('insuranceFile');
        if (insuranceFile) {
            insuranceFile.addEventListener('change', (e) => {
                handleFileUpload(e, 'insurance', 'insuranceFileName');
            });
        }
        
        // Business Certificate
        const certificateFile = document.getElementById('certificateFile');
        if (certificateFile) {
            certificateFile.addEventListener('change', (e) => {
                handleFileUpload(e, 'certificate', 'certificateFileName');
            });
        }
    }

    // Handle file upload
    function handleFileUpload(event, fileType, fileNameElementId) {
        const file = event.target.files[0];
        if (file) {
            // Validate file type
            const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            if (!validTypes.includes(file.type)) {
                showMessage('error', 'Please upload only PDF, JPG, or PNG files.');
                event.target.value = '';
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showMessage('error', 'File size must be less than 5MB.');
                event.target.value = '';
                return;
            }
            
            state.uploadedFiles[fileType] = file;
            document.getElementById(fileNameElementId).textContent = file.name;
            clearError(fileType + 'Error');
        }
    }

    // Add city to the list
    function addCity() {
        const cityInput = document.getElementById('cityInput');
        const city = cityInput.value.trim();
        
        if (city) {
            if (!state.cities.includes(city)) {
                state.cities.push(city);
                renderCities();
                cityInput.value = '';
                clearError('citiesError');
            } else {
                showError('citiesError', 'City already added.');
            }
        }
    }

    // Remove city from the list
    function removeCity(index) {
        state.cities.splice(index, 1);
        renderCities();
    }

    // Render cities as tags
    function renderCities() {
        const container = document.getElementById('citiesContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        state.cities.forEach((city, index) => {
            const tag = document.createElement('div');
            tag.className = 'city-tag';
            tag.innerHTML = `
                ${city}
                <button type="button" onclick="removeCity(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(tag);
        });
    }

    // Navigation functions
    function goToPrevStep() {
        if (state.currentStep > 1) {
            state.currentStep--;
            updateFormDisplay();
        }
    }

    function goToNextStep() {
        if (validateCurrentStep()) {
            if (state.currentStep < state.totalSteps) {
                state.currentStep++;
                updateFormDisplay();
            }
        }
    }

    // Update form display based on current step
    function updateFormDisplay() {
        // Update progress steps
        progressSteps.forEach((step, index) => {
            const stepNumber = index + 1;
            if (stepNumber < state.currentStep) {
                step.classList.remove('active');
                step.classList.add('completed');
            } else if (stepNumber === state.currentStep) {
                step.classList.add('active');
                step.classList.remove('completed');
            } else {
                step.classList.remove('active', 'completed');
            }
        });
        
        // Update form steps
        formSteps.forEach(step => {
            const stepNumber = parseInt(step.dataset.step);
            if (stepNumber === state.currentStep) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
        
        // Update buttons
        prevBtn.disabled = state.currentStep === 1;
        nextBtn.style.display = state.currentStep < state.totalSteps ? 'flex' : 'none';
        submitBtn.style.display = state.currentStep === state.totalSteps ? 'flex' : 'none';
    }

    // Validate current step
    function validateCurrentStep() {
        let isValid = true;
        
        switch(state.currentStep) {
            case 1:
                isValid = validateStep1();
                break;
            case 2:
                isValid = validateStep2();
                break;
            case 3:
                isValid = validateStep3();
                break;
            case 4:
                isValid = validateStep4();
                break;
        }
        
        return isValid;
    }

    // Validate step 1 fields
    function validateStep1() {
        const requiredFields = [
            { id: 'businessName', name: 'Business Name', errorId: 'businessNameError' },
            { id: 'registrationNumber', name: 'Registration Number', errorId: 'registrationNumberError' },
            { id: 'businessType', name: 'Business Type', errorId: 'businessTypeError' },
            { id: 'yearsInBusiness', name: 'Years in Business', errorId: 'yearsInBusinessError' },
            { id: 'businessAddress', name: 'Business Address', errorId: 'businessAddressError' },
            { id: 'aboutServices', name: 'About Services', errorId: 'aboutServicesError' }
        ];
        
        let isValid = true;
        
        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element) return;
            
            const value = element.value.trim();
            
            if (!value) {
                showError(field.errorId, `${field.name} is required`);
                isValid = false;
            } else if (field.id === 'yearsInBusiness') {
                const years = parseInt(value);
                if (isNaN(years) || years < 0 || years > 100) {
                    showError(field.errorId, 'Please enter a valid number between 0 and 100');
                    isValid = false;
                }
            }
        });
        
        // Validate cities
        if (state.cities.length === 0) {
            showError('citiesError', 'Please add at least one city');
            isValid = false;
        }
        
        return isValid;
    }

    // Validate step 2 fields
    function validateStep2() {
        const requiredFields = [
            { id: 'contactName', name: 'Contact Person Name', errorId: 'contactNameError' },
            { id: 'phoneNumber', name: 'Phone Number', errorId: 'phoneNumberError' },
            { id: 'emailAddress', name: 'Email Address', errorId: 'emailAddressError' },
            { id: 'preferredCommunication', name: 'Preferred Communication', errorId: 'preferredCommunicationError' }
        ];
        
        let isValid = true;
        
        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element) return;
            
            const value = element.value.trim();
            
            if (!value) {
                showError(field.errorId, `${field.name} is required`);
                isValid = false;
            } else if (field.id === 'emailAddress') {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(value)) {
                    showError(field.errorId, 'Please enter a valid email address');
                    isValid = false;
                }
            } else if (field.id === 'phoneNumber') {
                const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
                if (!phoneRegex.test(value.replace(/\D/g, ''))) {
                    showError(field.errorId, 'Please enter a valid phone number');
                    isValid = false;
                }
            }
        });
        
        return isValid;
    }

    // Validate step 3 fields
    function validateStep3() {
        let isValid = true;
        
        // Check required files
        if (!state.uploadedFiles.govId) {
            showError('govIdError', 'Government ID is required');
            isValid = false;
        }
        
        if (!state.uploadedFiles.license) {
            showError('licenseError', 'Business License is required');
            isValid = false;
        }
        
        return isValid;
    }

    // Validate step 4 fields
    function validateStep4() {
        const requiredFields = [
            { id: 'bankName', name: 'Bank Name', errorId: 'bankNameError' },
            { id: 'accountNumber', name: 'Account Number', errorId: 'accountNumberError' },
            { id: 'accountType', name: 'Account Type', errorId: 'accountTypeError' }
        ];
        
        let isValid = true;
        
        requiredFields.forEach(field => {
            const element = document.getElementById(field.id);
            if (!element) return;
            
            const value = element.value.trim();
            
            if (!value) {
                showError(field.errorId, `${field.name} is required`);
                isValid = false;
            }
        });
        
        return isValid;
    }

    // Validate individual field
    function validateField(element) {
        if (!element) return true;
        
        const value = element.value.trim();
        const id = element.id;
        
        // Find the label for this field
        const label = element.previousElementSibling;
        const fieldName = label ? label.textContent.replace('*', '').trim() : 'This field';
        
        if (element.hasAttribute('required') && !value) {
            showError(id + 'Error', `${fieldName} is required`);
            return false;
        }
        
        clearError(id + 'Error');
        return true;
    }

    // Clear error message
    function clearError(errorId) {
        const errorEl = document.getElementById(errorId);
        if (errorEl) {
            errorEl.style.display = 'none';
            errorEl.textContent = '';
        }
    }

    // Show error message
    function showError(errorId, message) {
        const errorEl = document.getElementById(errorId);
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        } else {
            console.warn(`Error element with ID ${errorId} not found`);
        }
    }

    // Show message banner
    function showMessage(type, text) {
        if (!messageEl) return;
        
        messageEl.className = `message ${type}`;
        messageEl.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${text}</span>
        `;
        messageEl.style.display = 'flex';
        
        // Auto hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
    }

    // Upload file to Supabase Storage
    async function uploadFile(file, path) {
        try {
            // In a real application, you would upload to Supabase Storage
            // For this example, we'll return a mock URL
            // Actual implementation would be:
            // const { data, error } = await supabase.storage
            //     .from('business-documents')
            //     .upload(path, file);
            
            // if (error) throw error;
            // return data.path;
            
            // Mock upload - in production, remove this and use above code
            return `https://example.com/uploads/${Date.now()}_${file.name}`;
        } catch (error) {
            console.error('Error uploading file:', error);
            throw new Error(`Failed to upload ${file.name}`);
        }
    }

    // Submit the form
    async function submitForm() {
        // First check if user is logged in
        if (!state.userId) {
            showMessage('error', 'Please login first.');
            setTimeout(() => {
                window.location.href = 'provider-registration.html';
            }, 2000);
            return;
        }
        
        // Validate all steps
        for (let i = 1; i <= state.totalSteps; i++) {
            state.currentStep = i;
            if (!validateCurrentStep()) {
                updateFormDisplay();
                showMessage('error', 'Please fix all errors before submitting.');
                return;
            }
        }
        
        // Show loading state
        state.isLoading = true;
        submitBtn.disabled = true;
        submitBtn.querySelector('.loader').style.display = 'block';
        submitBtn.querySelector('span').textContent = 'Submitting...';
        
        try {
            // Upload files and get URLs
            const govIdUrl = await uploadFile(state.uploadedFiles.govId, 'government-id');
            const licenseUrl = await uploadFile(state.uploadedFiles.license, 'business-license');
            const insuranceUrl = state.uploadedFiles.insurance ? 
                await uploadFile(state.uploadedFiles.insurance, 'insurance-certificate') : null;
            const certificateUrl = state.uploadedFiles.certificate ? 
                await uploadFile(state.uploadedFiles.certificate, 'business-certificate') : null;
            
            // Parse JSON arrays
            let otherLinks = [];
            try {
                const otherLinksInput = document.getElementById('otherLinks')?.value.trim();
                if (otherLinksInput) {
                    otherLinks = JSON.parse(otherLinksInput);
                }
            } catch (e) {
                console.warn('Invalid otherLinks format');
            }
            
            let subBusinessTypes = [];
            try {
                const subTypesInput = document.getElementById('subBusinessTypes')?.value.trim();
                if (subTypesInput) {
                    subBusinessTypes = JSON.parse(subTypesInput);
                }
            } catch (e) {
                console.warn('Invalid subBusinessTypes format');
            }
            
            // Prepare data for business_registrations table
            const businessData = {
                user_id: state.userId,
                business_name: document.getElementById('businessName').value.trim(),
                business_type_id: document.getElementById('businessType').value,
                registration_number: document.getElementById('registrationNumber').value.trim(),
                vat_gst_number: document.getElementById('vatGstNumber')?.value.trim() || null,
                website: document.getElementById('website')?.value.trim() || null,
                business_license_url: licenseUrl,
                business_address: document.getElementById('businessAddress').value.trim(),
                cities_served: state.cities,
                service_area: document.getElementById('serviceArea')?.value.trim() || null,
                years_in_business: parseInt(document.getElementById('yearsInBusiness').value),
                about_services: document.getElementById('aboutServices').value.trim(),
                contact_name: document.getElementById('contactName').value.trim(),
                phone_number: document.getElementById('phoneNumber').value.trim(),
                email_address: document.getElementById('emailAddress').value.trim(),
                alternate_contact: document.getElementById('alternateContact')?.value.trim() || null,
                preferred_communication: document.getElementById('preferredCommunication').value,
                linkedin_profile: document.getElementById('linkedinProfile')?.value.trim() || null,
                facebook_page: document.getElementById('facebookPage')?.value.trim() || null,
                instagram_handle: document.getElementById('instagramHandle')?.value.trim() || null,
                other_links: otherLinks,
                government_id_url: govIdUrl,
                business_certificate_url: certificateUrl,
                insurance_certificate_url: insuranceUrl,
                bank_name: document.getElementById('bankName').value.trim(),
                account_number: document.getElementById('accountNumber').value.trim(),
                account_type: document.getElementById('accountType').value,
                ifsc_code: document.getElementById('ifscCode')?.value.trim() || null,
                status: 'pending',
                sub_business_types: subBusinessTypes,
                service_radius: parseInt(document.getElementById('serviceRadius')?.value || 10),
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            console.log('Submitting business data:', businessData);
            
            // Insert data into business_registrations table
            const { data, error } = await supabase
                .from('business_registrations')
                .insert([businessData])
                .select();
            
            if (error) throw error;
            
            // Success!
            showMessage('success', 'Business registration submitted successfully! Your application is under review.');
            
            // Reset form after 3 seconds
            setTimeout(() => {
                resetForm();
                state.currentStep = 1;
                updateFormDisplay();
            }, 3000);
            
        } catch (error) {
            console.error('Error submitting form:', error);
            showMessage('error', `Submission failed: ${error.message}`);
        } finally {
            // Reset loading state
            state.isLoading = false;
            submitBtn.disabled = false;
            submitBtn.querySelector('.loader').style.display = 'none';
            submitBtn.querySelector('span').textContent = 'Submit Registration';
        }
    }

    // Reset the form
    function resetForm() {
        // Reset form fields
        document.querySelectorAll('input:not([type="file"]), select, textarea').forEach(element => {
            if (element.type === 'checkbox' || element.type === 'radio') {
                element.checked = false;
            } else {
                element.value = '';
            }
        });
        
        // Reset file uploads
        document.querySelectorAll('input[type="file"]').forEach(element => {
            element.value = '';
        });
        
        document.querySelectorAll('.file-name').forEach(element => {
            element.textContent = 'No file chosen';
        });
        
        // Reset state
        state.cities = [];
        state.uploadedFiles = {
            govId: null,
            license: null,
            insurance: null,
            certificate: null
        };
        
        // Clear errors
        document.querySelectorAll('.form-error').forEach(element => {
            element.style.display = 'none';
            element.textContent = '';
        });
        
        // Render empty cities
        renderCities();
        
        // Hide message
        if (messageEl) {
            messageEl.style.display = 'none';
        }
    }

    // Make removeCity function available globally
    window.removeCity = removeCity;
</script>
</body>
</html>
